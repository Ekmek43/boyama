<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes"> 
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"> 
    <meta name="apple-mobile-web-app-title" content="Fatma'nƒ±n Oyunu"> 
    <link rel="apple-touch-icon" href="icon.png"> 
    <title>Fatma'nƒ±n Boyama Kitabƒ±</title>
    <style>
        body {
            margin: 0; padding: 0;
            display: flex; flex-direction: column;
            background-color: #fff1f2;
            font-family: 'Comic Sans MS', sans-serif;
            height: 100vh; overflow: hidden;
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
            padding-top: env(safe-area-inset-top);
        }

        /* --- √úST PANEL --- */
        #toolbar {
            background: white;
            padding: 8px;
            display: flex; flex-direction: column;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            z-index: 100;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
            flex-shrink: 0;
        }

        .page-nav { display: flex; justify-content: space-between; align-items: center; }
        .nav-btn { background: #f43f5e; color: white; border: none; padding: 6px 12px; border-radius: 12px; font-weight: bold; font-size: 14px; }

        .palette { display: flex; gap: 8px; overflow-x: auto; padding: 5px 0; align-items: center; scrollbar-width: none; }
        .color-btn { width: 36px; height: 36px; border-radius: 50%; border: 2px solid #eee; flex-shrink: 0; transition: 0.2s; }
        .color-btn.active { border-color: #333; transform: scale(1.2); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        .rainbow-wheel { background: conic-gradient(red, yellow, lime, aqua, blue, magenta, red); border: 2px solid #ddd; position: relative; }
        #colorPickerInput { position: absolute; opacity: 0; width: 100%; height: 100%; left:0; top:0; }

        .tools-row { display: flex; justify-content: space-around; align-items: center; background: #fdf2f8; padding: 5px; border-radius: 15px; }
        .tool-btn { font-size: 20px; background: none; border: 2px solid transparent; border-radius: 10px; padding: 5px; transition: 0.2s; }
        .tool-btn.active-tool { background: white; border-color: #f43f5e; transform: scale(1.15); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        /* Kalem Boyutu Slider */
        .slider-group { display: flex; align-items: center; gap: 5px; font-size: 10px; color: #666; }
        input[type=range] { width: 60px; accent-color: #f43f5e; }

        /* --- OYUN ALANI (CANVAS) --- */
        #viewport {
            flex-grow: 1;
            position: relative;
            overflow: hidden; /* Dƒ±≈üarƒ± ta≈üanlarƒ± gizle */
            background-color: #fce7f3; /* Tuvalin dƒ±≈üƒ± */
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: none;
        }

        /* Canvas Grubu (Zoom ve Pan buraya uygulanacak) */
        #canvas-group {
            position: relative;
            transform-origin: center center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        canvas { 
            position: absolute; 
            left: 0; top: 0;
            border-radius: 10px; 
            touch-action: none; 
        }
        #paintLayer { z-index: 1; background: white; }
        #outlineLayer { z-index: 2; pointer-events: none; mix-blend-mode: multiply; }

        /* Zoom Kontrol Paneli (Alt Kƒ±sƒ±m) */
        #zoom-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            z-index: 200;
        }
        .zoom-icon { font-size: 14px; }

    </style>
</head>
<body>

<div id="toolbar">
    <div class="page-nav">
        <button class="nav-btn" onclick="changePage(-1)">‚¨ÖÔ∏è</button>
        <span id="page-indicator" style="color:#f43f5e; font-weight:bold;">Sayfa 1</span>
        <button class="nav-btn" onclick="changePage(1)">‚û°Ô∏è</button>
    </div>

    <div class="palette">
        <div class="color-btn rainbow-wheel" id="wheelBtn"><input type="color" id="colorPickerInput"></div>
        <div class="color-btn active" style="background: #fb7185;" data-color="#fb7185"></div>
        <div class="color-btn" style="background: #f472b6;" data-color="#f472b6"></div>
        <div class="color-btn" style="background: #c084fc;" data-color="#c084fc"></div>
        <div class="color-btn" style="background: #60a5fa;" data-color="#60a5fa"></div>
        <div class="color-btn" style="background: #4ade80;" data-color="#4ade80"></div>
        <div class="color-btn" style="background: #facc15;" data-color="#facc15"></div>
        <div class="color-btn" style="background: #000000;" data-color="#000000"></div>
    </div>

    <div class="tools-row">
        <button class="tool-btn active-tool" id="btn-brush" onclick="setTool('brush')">‚úèÔ∏è</button>
        <button class="tool-btn" id="btn-bucket" onclick="setTool('bucket')">ü™£</button>
        <button class="tool-btn" id="btn-pipette" onclick="setTool('pipette')">üß™</button>
        <button class="tool-btn" id="btn-eraser" onclick="setTool('eraser')">üßΩ</button>
        <button class="tool-btn" id="btn-move" onclick="setTool('move')" style="font-size: 24px;">‚úã</button>
        
        <div class="slider-group">
            <span>Kalƒ±nlƒ±k:</span>
            <input type="range" id="sizeSlider" min="2" max="40" value="10">
        </div>
        <button class="nav-btn" style="background:#94a3b8; padding:5px;" onclick="resetPaint()">Sil</button>
    </div>
</div>

<div id="viewport">
    <div id="canvas-group">
        <canvas id="paintLayer"></canvas>
        <canvas id="outlineLayer"></canvas>
    </div>
    
    <div id="zoom-controls">
        <span class="zoom-icon">üîç-</span>
        <input type="range" id="zoomSlider" min="0.5" max="3" step="0.1" value="1">
        <span class="zoom-icon">üîç+</span>
        <button onclick="resetView()" style="border:none; background:none; color:#f43f5e; font-weight:bold; font-size:12px;">Sƒ±fƒ±rla</button>
    </div>
</div>

<script>
    // --- RESƒ∞MLER ---
    const images = ["resim1.png", "resim2.png", "resim3.png", "resim4.png", "resim5.png", "resim6.png"];

    let currentPageIndex = 0;
    let currentTool = 'brush'; 
    let brushSize = 10;
    let selectedColor = "#fb7185";
    let isDrawing = false;
    let isBlankPage = false;

    // ZOOM ve PAN Deƒüi≈ükenleri
    let scale = 1;
    let panX = 0;
    let panY = 0;
    let startPanX = 0;
    let startPanY = 0;
    let isPanning = false;

    const paintCanvas = document.getElementById('paintLayer');
    const paintCtx = paintCanvas.getContext('2d', { willReadFrequently: true });
    const outlineCanvas = document.getElementById('outlineLayer');
    const outlineCtx = outlineCanvas.getContext('2d', { willReadFrequently: true });
    const canvasGroup = document.getElementById('canvas-group');
    const zoomSlider = document.getElementById('zoomSlider');
    const img = new Image();

    window.onload = () => loadPage(0);

    function loadPage(index) {
        if (index < 0) index = images.length;
        if (index >= images.length) {
            isBlankPage = true;
            document.getElementById('page-indicator').innerText = "Bo≈ü Sayfa ‚ú®";
            currentPageIndex = images.length;
            setupCanvas(true);
            return;
        }
        isBlankPage = false;
        currentPageIndex = index;
        document.getElementById('page-indicator').innerText = `Sayfa ${currentPageIndex + 1}`;
        img.src = images[currentPageIndex];
        img.onload = () => setupCanvas(false);
        img.onerror = () => alert("Resim y√ºklenemedi: " + images[currentPageIndex]);
    }

    function changePage(dir) {
        let newIndex = currentPageIndex + dir;
        if (newIndex > images.length) newIndex = 0;
        if (newIndex < 0) newIndex = images.length;
        loadPage(newIndex);
    }

    function setupCanvas(isEmpty) {
        resetView(); // Sayfa deƒüi≈üince zoom sƒ±fƒ±rlansƒ±n
        
        const toolbarH = document.getElementById('toolbar').offsetHeight;
        const availableW = window.innerWidth - 40;
        const availableH = window.innerHeight - toolbarH - 100; // Zoom bar i√ßin pay bƒ±rak

        let w, h;
        if (isEmpty) { 
            w = availableW; h = availableH; 
        } else {
            const scaleRatio = Math.min(availableW / img.width, availableH / img.height);
            w = Math.floor(img.width * scaleRatio);
            h = Math.floor(img.height * scaleRatio);
        }

        // Canvas Grubu ve Canvaslarƒ± boyutlandƒ±r
        canvasGroup.style.width = w + "px";
        canvasGroup.style.height = h + "px";
        paintCanvas.width = outlineCanvas.width = w;
        paintCanvas.height = outlineCanvas.height = h;

        outlineCtx.clearRect(0, 0, w, h);
        if (!isEmpty) outlineCtx.drawImage(img, 0, 0, w, h);
        resetPaint();
    }

    function resetPaint() {
        paintCtx.fillStyle = "white";
        paintCtx.fillRect(0, 0, paintCanvas.width, paintCanvas.height);
    }

    // --- ZOOM & PAN FONKSƒ∞YONLARI ---
    
    // Slider ile Zoom Yapma
    zoomSlider.addEventListener('input', (e) => {
        scale = parseFloat(e.target.value);
        updateTransform();
    });

    function updateTransform() {
        canvasGroup.style.transform = `translate(${panX}px, ${panY}px) scale(${scale})`;
    }

    function resetView() {
        scale = 1;
        panX = 0;
        panY = 0;
        zoomSlider.value = 1;
        updateTransform();
    }

    // --- ARA√áLAR ---
    function setTool(tool) {
        currentTool = tool;
        document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active-tool'));
        document.getElementById('btn-' + tool).classList.add('active-tool');
        
        // El aleti se√ßiliyse imleci deƒüi≈ütir
        if(tool === 'move') {
            document.body.style.cursor = 'grab';
        } else {
            document.body.style.cursor = 'default';
        }
    }

    // Renk Se√ßimi
    document.querySelectorAll('.palette .color-btn:not(.rainbow-wheel)').forEach(btn => {
        btn.addEventListener('click', () => {
            selectedColor = btn.dataset.color;
            highlightColorBtn(btn);
            if (currentTool === 'eraser' || currentTool === 'pipette' || currentTool === 'move') setTool('brush');
        });
    });

    document.getElementById('colorPickerInput').addEventListener('input', (e) => {
        selectedColor = e.target.value;
        highlightColorBtn(document.getElementById('wheelBtn'));
        if (currentTool === 'eraser' || currentTool === 'pipette' || currentTool === 'move') setTool('brush');
    });

    function highlightColorBtn(activeBtn) {
        document.querySelector('.palette .active')?.classList.remove('active');
        if(activeBtn) activeBtn.classList.add('active');
    }

    document.getElementById('sizeSlider').addEventListener('input', (e) => brushSize = e.target.value);

    // --- DRAW & TOUCH & PAN LOGIC ---
    
    // Koordinatlarƒ± Scale ve Pan'a g√∂re d√ºzeltme (M√úHENDƒ∞SLƒ∞K KISMI BURASI)
    function getCorrectCoordinates(e) {
        const rect = paintCanvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        
        // Ekranda g√∂r√ºnen boyutu (scale edilmi≈ü hali)
        const scaleX = paintCanvas.width / rect.width;
        const scaleY = paintCanvas.height / rect.height;

        return {
            x: (clientX - rect.left) * scaleX,
            y: (clientY - rect.top) * scaleY
        };
    }

    function start(e) {
        if(e.target.tagName === 'CANVAS') e.preventDefault();

        // TA≈ûIMA MODU
        if (currentTool === 'move') {
            isPanning = true;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            startPanX = clientX - panX;
            startPanY = clientY - panY;
            canvasGroup.style.cursor = 'grabbing';
            return;
        }

        const coords = getCorrectCoordinates(e);

        if (currentTool === 'pipette') { pickColor(coords.x, coords.y); return; }
        if (currentTool === 'bucket') { handleBucket(Math.floor(coords.x), Math.floor(coords.y)); return; }

        isDrawing = true;
        draw(e);
    }

    function draw(e) {
        if(e.target.tagName === 'CANVAS') e.preventDefault();

        // TA≈ûIMA ƒ∞≈ûLEMƒ∞
        if (isPanning && currentTool === 'move') {
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            panX = clientX - startPanX;
            panY = clientY - startPanY;
            updateTransform();
            return;
        }

        if (!isDrawing) return;
        
        const coords = getCorrectCoordinates(e);
        const x = coords.x;
        const y = coords.y;

        paintCtx.lineWidth = brushSize;
        paintCtx.lineCap = 'round';
        paintCtx.lineJoin = 'round';
        paintCtx.strokeStyle = (currentTool === 'eraser') ? "white" : selectedColor;

        paintCtx.lineTo(x, y);
        paintCtx.stroke();
        paintCtx.beginPath();
        paintCtx.moveTo(x, y);
    }

    function stop() {
        isDrawing = false;
        isPanning = false;
        paintCtx.beginPath();
        canvasGroup.style.cursor = 'default';
    }

    // --- YARDIMCILAR ---
    function pickColor(x, y) {
        try {
            const pixel = paintCtx.getImageData(x, y, 1, 1).data;
            const hex = "#" + ((1 << 24) + (pixel[0] << 16) + (pixel[1] << 8) + pixel[2]).toString(16).slice(1);
            selectedColor = hex;
            document.getElementById('colorPickerInput').value = hex;
            highlightColorBtn(document.getElementById('wheelBtn'));
            setTool('brush');
        } catch (e) {}
    }

    function handleBucket(startX, startY) {
        // Kova kodu aynƒ±, sadece koordinat d√ºzeltmesini yukarƒ±da yaptƒ±k
        try {
            const w = paintCanvas.width;
            const h = paintCanvas.height;
            const paintData = paintCtx.getImageData(0, 0, w, h);
            let outlineData = (!isBlankPage) ? outlineCtx.getImageData(0, 0, w, h).data : null;
            const startPos = (startY * w + startX) * 4;
            const startR = paintData.data[startPos];
            const startG = paintData.data[startPos+1];
            const startB = paintData.data[startPos+2];
            const fillRGB = hexToRgb(selectedColor);

            if (startR === fillRGB.r && startG === fillRGB.g && startB === fillRGB.b) return;

            const stack = [[startX, startY]];
            while(stack.length) {
                const [x, y] = stack.pop();
                const pos = (y * w + x) * 4;
                if (x < 0 || x >= w || y < 0 || y >= h) continue;
                if (outlineData && outlineData[pos+3] > 50 && outlineData[pos] < 100) continue;
                if (Math.abs(paintData.data[pos]-startR)<10 && Math.abs(paintData.data[pos+1]-startG)<10 && Math.abs(paintData.data[pos+2]-startB)<10) {
                    paintData.data[pos] = fillRGB.r; paintData.data[pos+1] = fillRGB.g; paintData.data[pos+2] = fillRGB.b; paintData.data[pos+3] = 255;
                    stack.push([x+1, y], [x-1, y], [x, y+1], [x, y-1]);
                }
            }
            paintCtx.putImageData(paintData, 0, 0);
        } catch(e) {}
    }
    
    function hexToRgb(hex) {
        const res = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return res ? {r: parseInt(res[1], 16), g: parseInt(res[2], 16), b: parseInt(res[3], 16)} : null;
    }

    // Olay Dinleyicileri (Container √ºzerine ekledik, canvasa deƒüil)
    // B√∂ylece zoomlu alanda hareket daha d√ºzg√ºn √ßalƒ±≈üƒ±r
    const viewport = document.getElementById('viewport');
    
    viewport.addEventListener('touchstart', start, {passive: false});
    viewport.addEventListener('touchmove', draw, {passive: false});
    viewport.addEventListener('touchend', stop);
    viewport.addEventListener('mousedown', start);
    viewport.addEventListener('mousemove', draw);
    window.addEventListener('mouseup', stop);
    window.addEventListener('resize', () => loadPage(currentPageIndex));

</script>
</body>
</html>